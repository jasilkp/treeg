<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Table</title>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        .editable { background-color: #f9f9f9; cursor: pointer; }
        input { width: 100%; border: none; background: transparent; }
    </style>
</head>
<body>

<h1>Accounting Table</h1>
<table id="accounting-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Site Name</th>
            <th>Description</th>
            <th>Income</th>
            <th>Expense</th>
            <th>Balance</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in entries %}
        <tr data-id="{{ entry.id }}">
            <td><input type="date" class="date-input" value="{{ entry.date }}"></td>
            <td contenteditable="true" class="editable">{{ entry.site_name }}</td>
            <td contenteditable="true" class="editable">{{ entry.description }}</td>
            <td contenteditable="true" class="editable numeric">{{ entry.income }}</td>
            <td contenteditable="true" class="editable numeric">{{ entry.expense }}</td>
            <td class="balance">{{ entry.balance }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<button onclick="addRow()">Add Row</button>

<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".editable, .date-input").forEach(element => {
        element.addEventListener("input", function() {
            saveData(this.closest("tr"));
        });
    });
});

function saveData(row) {
    let data = {
        id: row.getAttribute("data-id"),
        date: row.cells[0].querySelector("input").value,
        site_name: row.cells[1].innerText.trim(),
        description: row.cells[2].innerText.trim(),
        income: parseFloat(row.cells[3].innerText) || 0,
        expense: parseFloat(row.cells[4].innerText) || 0
    };

    fetch('/save_entry/', {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        row.setAttribute("data-id", data.id);
        row.querySelector(".balance").innerText = data.balance.toFixed(2);
    });
}

function addRow() {
    let table = document.getElementById("accounting-table").getElementsByTagName("tbody")[0];
    let newRow = table.insertRow();
    newRow.innerHTML = `
        <td><input type="date" class="date-input"></td>
        <td contenteditable="true" class="editable"></td>
        <td contenteditable="true" class="editable"></td>
        <td contenteditable="true" class="editable numeric">0.00</td>
        <td contenteditable="true" class="editable numeric">0.00</td>
        <td class="balance">0.00</td>
    `;

    newRow.querySelectorAll(".editable, .date-input").forEach(cell => {
        cell.addEventListener("input", function() {
            saveData(this.closest("tr"));
        });
    });

    saveData(newRow);  // Ensure new row is saved immediately
}

function getCSRFToken() {
    let token = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return token ? token.split('=')[1] : '';
}
</script>

</body>
</html>

